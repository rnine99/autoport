
from utility_objective_functions import sinr_balancing_power_constraint
import numpy as np

def select_ports(K, N_selected, N_Ports, Pt, n, H, noise):
    """
    Select N_selected out of N_Ports ports to maximize the average objective value.

    Args:
        K: The number of users.
        N_selected: The number ports to be selected.
        N_Ports: Total number of ports available.
        Pt: Total transmit power available.
        n: Total number of channel realizations.
        H: Numpy array of shape (n, N_Ports, K).
        noise: Noise power.

    Returns:
        port_sample: Numpy array of shape (n, N_selected).
                     Values must be integers from 0 to N_Ports-1, no repeats per row.

    # --- ⬇️ REFERENCE EXAMPLE (DO NOT COPY, JUST REFERENCE) ⬇️ ---
    # Example: Random Selection
    # port_sample = np.zeros((n, N_selected), dtype=int)
    # for j in range(n):
    #     # Randomly choose N_selected ports
    #     p = np.random.choice(N_Ports, N_selected, replace=False)
    #     port_sample[j, :] = p
    # return port_sample
    # -----------------------------------------------------------
    """
    port_sample = np.zeros((n, N_selected), dtype=int)
    for j in range(n):
        # Randomly choose N_selected ports
        p = np.random.choice(N_Ports, N_selected, replace=False)
        port_sample[j, :] = p

    # Apply genetic algorithm with selection function based on SINR
    for generation in range(100):
        new_ports = []
        for i in range(K):
            # Find the best port for each user
            SINR = np.zeros(N_Ports)
            for k in range(N_Ports):
                SINR[k] = (np.abs(H[i, k, i])**2 * Pt) / (noise + np.sum(np.abs(H[i, k, i])))
            max_SINR_port = np.argmax(SINR)

            # Append the best port to the new_ports list
            new_ports.append(max_SINR_port)

        # Replace the current row of port_sample with the new_ports
        port_sample[np.random.randint(n), :] = new_ports

    return port_sample

