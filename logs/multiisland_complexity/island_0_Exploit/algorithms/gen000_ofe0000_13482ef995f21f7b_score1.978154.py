
from utility_objective_functions import sinr_balancing_power_constraint
import numpy as np

def select_ports(K, N_selected, N_Ports, Pt, n, H, noise):
    """
    Select N_selected out of N_Ports ports to maximize the average objective value.

    Args:
        K: The number of users.
        N_selected: The number ports to be selected.
        N_Ports: Total number of ports available.
        Pt: Total transmit power available.
        n: Total number of channel realizations.
        H: Numpy array of shape (n, N_Ports, K).
        noise: Noise power.

    Returns:
        port_sample: Numpy array of shape (n, N_selected).
                     Values must be integers from 0 to N_Ports-1, no repeats per row.

    # --- ⬇️ REFERENCE EXAMPLE (DO NOT COPY, JUST REFERENCE) ⬇️ ---
    # Example: Random Selection
    # port_sample = np.zeros((n, N_selected), dtype=int)
    # for j in range(n):
    #     # Randomly choose N_selected ports
    #     p = np.random.choice(N_Ports, N_selected, replace=False)
    #     port_sample[j, :] = p
    # return port_sample
    # -----------------------------------------------------------
    """
    sinr_mean = np.mean(H, axis=0)
    sinr_mean = sinr_mean.reshape(-1, 1)

    # Initialize port_sample with zeros
    port_sample = np.zeros((n, N_selected), dtype=int)

    # Select the top N_selected ports with the highest average SINR
    for j in range(n):
        top_ports = np.argsort(sinr_mean[j])[::-1][:N_selected]
        port_sample[j, :] = top_ports

    for j in range(n):
        # Iterate over each channel realization
        max_SINR = 0
        selected_ports = None

        for i in range(K):
            # Find the best port for each user
            SINR = np.zeros(N_Ports)
            for k in range(N_Ports):
                SINR[k] = (np.abs(H[j, k, i])**2 * Pt) / (noise + np.sum(np.abs(H[j, k, i])))
            max_SINR_port = np.argmax(SINR)

            # Append the best port to the selected_ports list
            if selected_ports is None:
                selected_ports = [max_SINR_port]
            else:
                selected_ports.append(max_SINR_port)

                # Enforce no repeats in each row
                while max_SINR_port in selected_ports:
                    max_SINR_port = np.random.choice(N_Ports)

        # Convert selected_ports to a NumPy array and store it in port_sample
        port_sample[j, :] = selected_ports

    return port_sample

